---
title: webpack打包优化之分析打包图
category: webpack
tags: [webpack, 构建工具]
date: 2018-7-31
---

开发环境下利用`webpack-bundle-analyzer`来生成打包依赖图进行分析，进行项目优化
<!-- more -->

## 分析
``` shell
yarn add webpack-bundle-analyzer -D
```

``` javascript
const BundleAnalyzerPlugin = require('webpack-bundle-analyzer')

plugins: [
  new BundleAnalyzerPlugin()
]
```
优化前，可以看到这里出现了基本两个一样的东西，都引入了`echarts`和`zrender`，

![](https://ws1.sinaimg.cn/large/ad9f1193gy1ftty3eajt6j21h80q2ti9.jpg)

还有就是引入的`moment`偏大，因为引入了其他语言和地区，而这个项目只需要中文区域的

![](https://ws1.sinaimg.cn/large/ad9f1193gy1fttyoenmb2j20bi0armye.jpg)

## 优化

### 问题一

前者的问题是自己的代码书写问题，有两个相似的组件没有提取成一个公共组件，两次引入了`v-charts`的图表，而`v-charts`又依赖于`echarts`，所以就出现了重复性引用，不过项目已经引用了`CommonsChunkPlugin`，为什么e-charts没被分离成一个单独的js文件呢？
发现是异步组件的问题。

![](https://ws1.sinaimg.cn/large/ad9f1193gy1ftu0zzn9e1j20hi02vaaa.jpg)

这种引入组件的写法，会使得webpack打包两个js文件，所以因为默认是显示`MysqlReport`的，可以将其改写为直接引入，`RedisReport`保持异步引入

``` javascript
import MysqlReport from './mysqlReport.vue'

export default {
  components: {
    MysqlReport,
    RedisReport: () => import('./RedisReport.vue')
  }
}
```

echarts已经被打包到vendor里，目的达成

![](https://ws1.sinaimg.cn/large/ad9f1193gy1ftu1pk771zj21h90qfn6r.jpg)

但是为了少写重复性代码，我还是将`MysqlReport`和`RedisReport`进行重构，写成单独一个组件。

### 问题二

`iview`所依赖的`moment.js`，默认引入所有区域，所以多了很多未使用到的代码，利用`ContextReplacementPlugin`来优化。

``` javascript
new webpack.ContextReplacementPlugin(
  /moment[\/\\]locale$/,
  /zh-cn/
)
```

## 总结

使用异步组件引入的方式引入组件，需要考虑到多个异步组件会不会引入相同的依赖模块，如果有，该依赖模块可能会被打包多次。

开发的时候可以配置`BundleAnalyzer`来分析打包文件的结构，进行审查以及进一步优化。

最终打包文件的优化结果，还行，优化一点是一点。

![](https://ws1.sinaimg.cn/large/ad9f1193gy1ftu2vvk21yj206x03ya9x.jpg)
![](https://ws1.sinaimg.cn/large/ad9f1193gy1ftu2wkh44mj207s041glh.jpg)

可以继续利用[`路由懒加载`](https://router.vuejs.org/zh/guide/advanced/lazy-loading.html)来加快首页加载速度。

